#!/bin/bash

SERVICE_SCRIPT="./stopstart.sh"
HEALTH_CHECK_URL="http://localhost/admin/health"
ERROR_THRESHOLD=3
CHECK_INTERVAL_SECONDS=60
LOG_FILE="health_check.log"

consecutive_errors=0

while true; do
    # Perform health check using curl and capture timestamp
    timestamp=$(date +"%Y-%m-%d %H:%M:%S")
    response_code=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL")

    if [ "$response_code" -eq 502 ]; then
        consecutive_errors=$((consecutive_errors + 1))
        echo "$timestamp - Health check failed ($consecutive_errors/$ERROR_THRESHOLD) - Status Code: $response_code" >> "$LOG_FILE"

        if [ "$consecutive_errors" -ge "$ERROR_THRESHOLD" ]; then
            echo "$timestamp - Restarting the service..." >> "$LOG_FILE"
            # Add your logic to restart the service
            bash "$SERVICE_SCRIPT"
            
            # Reset consecutive errors after restarting
            consecutive_errors=0
        fi
    else
        consecutive_errors=0
        echo "$timestamp - Health check succeeded - Status Code: $response_code" >> "$LOG_FILE"
    fi

    # Wait for the next check interval
    sleep "$CHECK_INTERVAL_SECONDS"
done
