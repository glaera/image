import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

@Service
public class OpenTextAuthenticationService {

    @Value("${opentext.username}")
    private String username;

    @Value("${opentext.password}")
    private String password;

    @Value("${opentext.contentServerUrl}")
    private String contentServerUrl;

    public String authenticate() {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Content-Type", "application/x-www-form-urlencoded");

        // Construct the request body with credentials
        String requestBody = "Username=" + username + "&Password=" + password;
        HttpEntity<String> request = new HttpEntity<>(requestBody, headers);

        // Make a POST request to obtain the session ticket
        ResponseEntity<String> response = new RestTemplate().exchange(
                contentServerUrl + "/api/v1/authentication", HttpMethod.POST, request, String.class);

        // Extract the session ticket from the response headers
        String ticket = response.getHeaders().getFirst("Set-Cookie");
        if (ticket != null && ticket.startsWith("OTAuthSessionId")) {
            // Extract the ticket value from the Set-Cookie header
            ticket = ticket.split(";")[0].split("=")[1];
            return ticket;
        } else {
            return null;
        }
    }
}
